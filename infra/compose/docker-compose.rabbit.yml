services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: lab-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbitmq_management load_definitions \"/etc/rabbitmq/definitions.json\""
    volumes:
      - ../rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  producer-api:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.module
      args:
        MODULE_DIR: apps/producer-api
    container_name: lab-producer
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: rabbit
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      LAB_RABBIT_EXCHANGE: lab.exchange
      LAB_RABBIT_ROUTING_KEY: lab.events
    ports:
      - "8080:8080"

  # -------- Consumers (NAIVE) --------
  consumer-naive-1:
    profiles: ["naive"]
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.module
      args:
        MODULE_DIR: apps/consumer-naive
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: rabbit
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lab
      SPRING_DATASOURCE_USERNAME: lab
      SPRING_DATASOURCE_PASSWORD: lab
      LAB_RABBIT_QUEUE: lab.events.queue

      # Failure injection (override as needed)
      LAB_FAIL_MODE: NONE
      LAB_FAIL_RATE: "0.0"
      LAB_FAIL_SLEEP_MS: "0"
      LAB_FAIL_ON_MESSAGE_IDS: ""
    ports:
      - "8081:8081"

  consumer-naive-2:
    profiles: ["naive"]
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.module
      args:
        MODULE_DIR: apps/consumer-naive
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: rabbit
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lab
      SPRING_DATASOURCE_USERNAME: lab
      SPRING_DATASOURCE_PASSWORD: lab
      LAB_RABBIT_QUEUE: lab.events.queue

      LAB_FAIL_MODE: NONE
      LAB_FAIL_RATE: "0.0"
      LAB_FAIL_SLEEP_MS: "0"
      LAB_FAIL_ON_MESSAGE_IDS: ""
    ports:
      - "8083:8081"

  consumer-naive-3:
    profiles: ["naive"]
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.module
      args:
        MODULE_DIR: apps/consumer-naive
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: rabbit
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lab
      SPRING_DATASOURCE_USERNAME: lab
      SPRING_DATASOURCE_PASSWORD: lab
      LAB_RABBIT_QUEUE: lab.events.queue

      LAB_FAIL_MODE: NONE
      LAB_FAIL_RATE: "0.0"
      LAB_FAIL_SLEEP_MS: "0"
      LAB_FAIL_ON_MESSAGE_IDS: ""
    ports:
      - "8085:8081"

  # -------- Consumers (IDEMPOTENT) --------
  consumer-idempotent-1:
    profiles: ["idempotent"]
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.module
      args:
        MODULE_DIR: apps/consumer-idempotent
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: rabbit
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lab
      SPRING_DATASOURCE_USERNAME: lab
      SPRING_DATASOURCE_PASSWORD: lab
      LAB_RABBIT_QUEUE: lab.events.queue

      LAB_FAIL_MODE: NONE
      LAB_FAIL_RATE: "0.0"
      LAB_FAIL_SLEEP_MS: "0"
      LAB_FAIL_ON_MESSAGE_IDS: ""
    ports:
      - "8082:8082"

  consumer-idempotent-2:
    profiles: ["idempotent"]
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.module
      args:
        MODULE_DIR: apps/consumer-idempotent
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: rabbit
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lab
      SPRING_DATASOURCE_USERNAME: lab
      SPRING_DATASOURCE_PASSWORD: lab
      LAB_RABBIT_QUEUE: lab.events.queue

      LAB_FAIL_MODE: NONE
      LAB_FAIL_RATE: "0.0"
      LAB_FAIL_SLEEP_MS: "0"
      LAB_FAIL_ON_MESSAGE_IDS: ""
    ports:
      - "8084:8082"

  consumer-idempotent-3:
    profiles: ["idempotent"]
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.module
      args:
        MODULE_DIR: apps/consumer-idempotent
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: rabbit
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lab
      SPRING_DATASOURCE_USERNAME: lab
      SPRING_DATASOURCE_PASSWORD: lab
      LAB_RABBIT_QUEUE: lab.events.queue

      LAB_FAIL_MODE: NONE
      LAB_FAIL_RATE: "0.0"
      LAB_FAIL_SLEEP_MS: "0"
      LAB_FAIL_ON_MESSAGE_IDS: ""
    ports:
      - "8086:8082"
